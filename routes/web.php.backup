<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;
use App\Http\Controllers\Web\DashboardController;
use App\Http\Controllers\Web\UsuarioWebController;
use App\Http\Controllers\Web\ProductoWebController;
use App\Http\Controllers\Web\ClienteWebController;
use App\Http\Controllers\Web\AutenticacionController;

/*
|--------------------------------------------------------------------------
RUTAS WEB DE VENTASFIX - SISTEMA DE AUTENTICACIÃ“N SANCTUM
|--------------------------------------------------------------------------
|
ARCHIVO ACTUALIZADO: 14 de Septiembre 2025
PROPÃ“SITO: Definir todas las rutas web del sistema VentasFix con autenticaciÃ³n
|
SISTEMA DE AUTENTICACIÃ“N IMPLEMENTADO:
Laravel Sanctum para autenticaciÃ³n web (sesiones, no tokens)
Middleware 'auth:sanctum' protege todas las rutas importantes
RedirecciÃ³n automÃ¡tica a /login cuando no estÃ©s autenticado
SesiÃ³n configurada para 15 minutos de inactividad
|
ESTRUCTURA ORGANIZADA:
| 1. Rutas protegidas del Dashboard (requieren login)
| 2. CRUD de Usuarios (todas protegidas)
| 3. CRUD de Productos (todas protegidas)  
| 4. CRUD de Clientes (todas protegidas)
| 5. Rutas pÃºblicas de autenticaciÃ³n (login/logout)
|
 SEGURIDAD:
| - Solo /login es accesible sin autenticaciÃ³n
| - Todas las demÃ¡s rutas redirigen al login automÃ¡ticamente
| - Logout requiere autenticaciÃ³n (lÃ³gico, solo usuarios logueados pueden hacer logout)
|
*/

// ============================================================================
// RUTAS PRINCIPALES - DASHBOARD (PROTEGIDAS CON AUTENTICACIÃ“N)
// ============================================================================
// 
// ESTAS RUTAS ESTÃN PROTEGIDAS: Solo usuarios autenticados pueden acceder
// 
// Â¿CÃ“MO FUNCIONA EL MIDDLEWARE?
// 1. Usuario intenta ir a "/" sin estar logueado
// 2. Laravel intercepta la peticiÃ³n y ve middleware('auth')
// 3. Sanctum verifica si hay una SESIÃ“N activa (no busca tokens)
// 4. Como no hay sesiÃ³n â†’ Laravel redirige automÃ¡ticamente a /login
// 5. Usuario se loguea â†’ Laravel crea sesiÃ³n â†’ usuario puede acceder

// ðŸ”§ RUTA TEMPORAL PARA PRUEBAS (se puede quitar despuÃ©s)
Route::get('/login-preview', function () {
    return view('vertical-menu-template-no-customizer.app-auth-login');
})->name('login.preview');

// ðŸ  INDEX PRINCIPAL - Dashboard completo de VentasFix con manejo de errores
// URL: / â†’ Vista principal con navegaciÃ³n funcional
// REQUIERE: Usuario autenticado + verificaciÃ³n de timeout de sesiÃ³n  
Route::get('/', [DashboardController::class, 'index'])
    ->name('dashboard')
    ->middleware(['auth', 'check.session.timeout']);

// ðŸ“Š RUTA ALTERNATIVA AL DASHBOARD 
// Misma funcionalidad que '/' pero con URL mÃ¡s descriptiva
Route::get('/dashboard', function () {
    return redirect()->route('dashboard');
})
    ->name('dashboard.alt')
    ->middleware(['auth', 'check.session.timeout']);

// ============================================================================
// ðŸ‘¥ GESTIÃ“N DE USUARIOS - TODAS LAS RUTAS PROTEGIDAS
// ============================================================================
//
// SEGURIDAD IMPLEMENTADA: Cada ruta tiene middleware('auth')
// 
// Â¿QUÃ‰ SIGNIFICA ESTO EN LA PRÃCTICA?
// - Si intentas ir a /usuarios sin login â†’ automÃ¡tico redirect a /login
// - Solo usuarios autenticados pueden ver, crear, editar o eliminar usuarios
// - Sanctum verifica la SESIÃ“N (no tokens) antes de cada peticiÃ³n
//
// FUNCIONALIDADES DISPONIBLES:
// Ver lista de usuarios
// Buscar usuario por ID
// Crear nuevos usuarios  
// Actualizar usuarios existentes
// Eliminar usuarios con confirmaciÃ³n
// Ver detalles individuales de cada usuario

// LISTAR TODOS LOS USUARIOS - Solo usuarios autenticados con timeout
// URL: /usuarios â†’ Muestra tabla con todos los usuarios registrados
Route::get('/usuarios', [UsuarioWebController::class, 'index'])
    ->name('usuarios.index')
    ->middleware(['auth', 'check.session.timeout']);

// ============================================================================
// ðŸ‘¥ GESTIÃ“N DE USUARIOS - TODAS LAS RUTAS PROTEGIDAS
// ============================================================================
//
// SEGURIDAD IMPLEMENTADA: Cada ruta tiene middleware('auth')
// 
// ðŸ” BUSCAR USUARIO POR ID ESPECÃFICO - FunciÃ³n especial protegida
// URL: /usuarios/buscar-por-id â†’ Formulario para buscar usuario por su ID
Route::get('/usuarios/buscar-por-id', [UsuarioWebController::class, 'listById'])
    ->name('usuarios.list-by-id')
    ->middleware('auth');

// ðŸ”„ ACTUALIZAR USUARIO POR ID ESPECÃFICO - FunciÃ³n especial protegida
// URL: /usuarios/actualizar-por-id â†’ Permite buscar y actualizar usuario por su ID
// SOPORTA: GET (mostrar formulario) y POST (procesar actualizaciÃ³n)
Route::match(['GET', 'POST'], '/usuarios/actualizar-por-id', [UsuarioWebController::class, 'actualizarPorId'])
    ->name('usuarios.actualizar-por-id')
    ->middleware('auth');

// âŒ ELIMINAR USUARIO POR ID ESPECÃFICO - FunciÃ³n con confirmaciÃ³n protegida  
// URL: /usuarios/eliminar-por-id â†’ Busca usuario y muestra confirmaciÃ³n
// SOPORTA: GET (mostrar confirmaciÃ³n) y POST (buscar usuario a eliminar)
Route::match(['GET', 'POST'], '/usuarios/eliminar-por-id', [UsuarioWebController::class, 'eliminarPorId'])
    ->name('usuarios.eliminar-por-id')
    ->middleware('auth');

// ðŸ’¥ PROCESAMIENTO FINAL DE ELIMINACIÃ“N - AcciÃ³n definitiva protegida
// URL: DELETE /usuarios/eliminar-por-id/procesar â†’ Elimina definitivamente el usuario
// REQUIERE: ConfirmaciÃ³n previa del usuario antes de ejecutar
Route::delete('/usuarios/eliminar-por-id/procesar', [UsuarioWebController::class, 'procesarEliminarPorId'])
    ->name('usuarios.eliminar-por-id.procesar')
    ->middleware('auth');

// âž• CREAR NUEVOS USUARIOS - Ambas rutas protegidas
// URL: GET /usuarios/crear â†’ Muestra formulario para nuevo usuario
// URL: POST /usuarios/crear â†’ Procesa y guarda el nuevo usuario creado
Route::get('/usuarios/crear', [UsuarioWebController::class, 'create'])
    ->name('usuarios.create')
    ->middleware('auth');
    
Route::post('/usuarios/crear', [UsuarioWebController::class, 'store'])
    ->name('usuarios.store')
    ->middleware('auth');

// ðŸ‘€ VISUALIZAR Y EDITAR USUARIOS - Operaciones bÃ¡sicas protegidas  
// URL: /usuarios/{id} â†’ Muestra detalles completos del usuario seleccionado
// URL: /usuarios/{id}/editar â†’ Formulario pre-cargado para editar usuario
Route::get('/usuarios/{id}', [UsuarioWebController::class, 'show'])
    ->name('usuarios.show')
    ->middleware('auth');
    
Route::get('/usuarios/{id}/editar', [UsuarioWebController::class, 'edit'])
    ->name('usuarios.edit')
    ->middleware('auth');

// ============================================================================
// ðŸ“¦ GESTIÃ“N DE PRODUCTOS - INVENTARIO COMPLETO PROTEGIDO
// ============================================================================
//
// ðŸ”’ MISMA SEGURIDAD QUE USUARIOS: middleware('auth') en TODAS las rutas
//
// Â¿CÃ“MO FUNCIONA LA PROTECCIÃ“N?
// - Sin sesiÃ³n activa â†’ redirect automÃ¡tico a /login
// - Con sesiÃ³n vÃ¡lida â†’ acceso completo a inventario
// - Sanctum verifica cada peticiÃ³n contra la sesiÃ³n del usuario
//
// ðŸŽ¯ FUNCIONALIDADES DE INVENTARIO:
// âœ… Ver catÃ¡logo completo de productos
// âœ… Buscar producto especÃ­fico por ID
// âœ… Agregar nuevos productos al inventario
// âœ… Actualizar informaciÃ³n de productos  
// âœ… Eliminar productos con confirmaciÃ³n
// âœ… Ver detalles individuales completos

// ðŸ“‹ CATÃLOGO COMPLETO - Lista todos los productos del inventario
// URL: /productos â†’ Tabla con todos los productos registrados
Route::get('/productos', [ProductoWebController::class, 'index'])
    ->name('productos.index')
    ->middleware('auth');

// ðŸ” BUSCAR PRODUCTO POR ID - BÃºsqueda especÃ­fica protegida
// URL: /productos/buscar-por-id â†’ Formulario para localizar producto por ID
Route::get('/productos/buscar-por-id', [ProductoWebController::class, 'listById'])
    ->name('productos.list-by-id')
    ->middleware('auth');

// ðŸ”„ ACTUALIZAR PRODUCTO POR ID - ModificaciÃ³n especÃ­fica protegida
// URL: /productos/actualizar-por-id â†’ Busca y actualiza producto especÃ­fico
// SOPORTA: GET (formulario de bÃºsqueda) y POST (procesar actualizaciÃ³n)
Route::match(['GET', 'POST'], '/productos/actualizar-por-id', [ProductoWebController::class, 'actualizarPorId'])
    ->name('productos.actualizar-por-id')
    ->middleware('auth');

// âŒ ELIMINAR PRODUCTO POR ID - EliminaciÃ³n con confirmaciÃ³n protegida
// URL: /productos/eliminar-por-id â†’ Busca producto y solicita confirmaciÃ³n  
// SOPORTA: GET (mostrar confirmaciÃ³n) y POST (buscar producto a eliminar)
Route::match(['GET', 'POST'], '/productos/eliminar-por-id', [ProductoWebController::class, 'eliminarPorId'])
    ->name('productos.eliminar-por-id')
    ->middleware('auth');

// ðŸ’¥ PROCESAMIENTO FINAL DE ELIMINACIÃ“N - AcciÃ³n definitiva protegida  
// URL: DELETE /productos/eliminar-por-id/procesar â†’ Elimina definitivamente el producto
// REQUIERE: ConfirmaciÃ³n previa antes de ejecutar la eliminaciÃ³n
Route::delete('/productos/eliminar-por-id/procesar', [ProductoWebController::class, 'procesarEliminarPorId'])
    ->name('productos.eliminar-por-id.procesar')
    ->middleware('auth');

// âž• AGREGAR NUEVO PRODUCTO - Formulario de creaciÃ³n protegido
// URL: /productos/crear â†’ Formulario para registrar nuevo producto en inventario
Route::get('/productos/crear', [ProductoWebController::class, 'create'])
    ->name('productos.create')
    ->middleware('auth');

// ðŸ’¾ GUARDAR PRODUCTO NUEVO - Procesamiento POST protegido
// URL: POST /productos â†’ Recibe datos del formulario y crea el producto
Route::post('/productos', [ProductoWebController::class, 'store'])
    ->name('productos.store')
    ->middleware('auth');

// ðŸ‘€ VER DETALLES DEL PRODUCTO - InformaciÃ³n completa protegida
// URL: /productos/{id} â†’ Muestra toda la informaciÃ³n del producto seleccionado
Route::get('/productos/{id}', [ProductoWebController::class, 'show'])
    ->name('productos.show')
    ->middleware('auth');

// âœï¸ EDITAR PRODUCTO EXISTENTE - Formulario pre-cargado protegido
// URL: /productos/{id}/editar â†’ Formulario con datos actuales para modificar producto
Route::get('/productos/{id}/editar', [ProductoWebController::class, 'edit'])
    ->name('productos.edit')
    ->middleware('auth');

// ðŸ”„ ACTUALIZAR PRODUCTO - Procesamiento PUT protegido
// URL: PUT /productos/{id} â†’ Guarda los cambios del formulario de ediciÃ³n  
Route::put('/productos/{id}', [ProductoWebController::class, 'update'])
    ->name('productos.update')
    ->middleware('auth');

// ðŸ—‘ï¸ ELIMINAR PRODUCTO - EliminaciÃ³n directa protegida
// URL: DELETE /productos/{id} â†’ Elimina producto del inventario
Route::delete('/productos/{id}', [ProductoWebController::class, 'destroy'])
    ->name('productos.destroy')
    ->middleware('auth');

// ============================================================================
// ðŸ‘¥ GESTIÃ“N DE CLIENTES - CARTERA COMPLETA PROTEGIDA
// ============================================================================
//
// ðŸ”’ SEGURIDAD CONSISTENTE: middleware('auth') en TODAS las rutas
//
// ðŸ“Œ RECORDATORIO IMPORTANTE:
// - Sanctum en aplicaciones WEB usa SESIONES (no tokens API)
// - Sin login activo â†’ redirect automÃ¡tico a /login
// - Con sesiÃ³n vÃ¡lida â†’ acceso completo a cartera de clientes
//
// ðŸŽ¯ GESTIÃ“N COMPLETA DE CLIENTES:
// âœ… Ver cartera completa de clientes
// âœ… Buscar cliente especÃ­fico por ID
// âœ… Registrar nuevos clientes  
// âœ… Actualizar informaciÃ³n de clientes
// âœ… Eliminar clientes con confirmaciÃ³n
// âœ… Ver historial y detalles individuales

// ðŸ“‹ CARTERA COMPLETA - Lista todos los clientes registrados  
// URL: /clientes â†’ Tabla con todos los clientes de la empresa
Route::get('/clientes', [ClienteWebController::class, 'index'])
    ->name('clientes.index')
    ->middleware('auth');

// ðŸ” BUSCAR CLIENTE POR ID - BÃºsqueda especÃ­fica protegida
// URL: /clientes/buscar-por-id â†’ Formulario para localizar cliente por su ID  
Route::get('/clientes/buscar-por-id', [ClienteWebController::class, 'mostrarListarPorId'])
    ->name('clientes.list-by-id')
    ->middleware('auth');

// âž• REGISTRAR NUEVO CLIENTE - Formulario de registro protegido
// URL: /clientes/crear â†’ Formulario para agregar cliente a la cartera
Route::get('/clientes/crear', [ClienteWebController::class, 'mostrarCrear'])
    ->name('clientes.create')
    ->middleware('auth');

// ðŸ’¾ GUARDAR CLIENTE NUEVO - Procesamiento POST protegido
// URL: POST /clientes â†’ Recibe datos del formulario y registra el cliente
Route::post('/clientes', [ClienteWebController::class, 'crear'])
    ->name('clientes.store')
    ->middleware('auth');

// ðŸ”„ ACTUALIZAR CLIENTE POR ID - Operaciones de modificaciÃ³n protegidas
// URL: GET /clientes/actualizar-por-id â†’ Formulario de bÃºsqueda para actualizar
// URL: POST /clientes/actualizar-por-id â†’ Procesa la actualizaciÃ³n del cliente  
Route::get('/clientes/actualizar-por-id', [ClienteWebController::class, 'mostrarActualizarPorId'])
    ->name('clientes.actualizar-por-id')
    ->middleware('auth');
    
Route::post('/clientes/actualizar-por-id', [ClienteWebController::class, 'actualizarPorId'])
    ->name('clientes.actualizar-por-id.post')
    ->middleware('auth');

// âŒ ELIMINAR CLIENTE POR ID - EliminaciÃ³n con confirmaciÃ³n protegida
// URL: /clientes/eliminar-por-id â†’ Busca cliente y solicita confirmaciÃ³n
// SOPORTA: GET (mostrar confirmaciÃ³n) y POST (buscar cliente a eliminar)
Route::match(['GET', 'POST'], '/clientes/eliminar-por-id', [ClienteWebController::class, 'eliminarPorId'])
    ->name('clientes.eliminar-por-id')
    ->middleware('auth');

// ðŸ’¥ PROCESAMIENTO FINAL DE ELIMINACIÃ“N - AcciÃ³n definitiva protegida
// URL: DELETE /clientes/eliminar-por-id/procesar â†’ Elimina definitivamente el cliente
// REQUIERE: ConfirmaciÃ³n previa antes de proceder con la eliminaciÃ³n
Route::delete('/clientes/eliminar-por-id/procesar', [ClienteWebController::class, 'procesarEliminarPorId'])
    ->name('clientes.eliminar-por-id.procesar')
    ->middleware('auth');

// ============================================================================
// ðŸ”“ AUTENTICACIÃ“N WEB - ÃšNICAS RUTAS PÃšBLICAS (SIN MIDDLEWARE)
// ============================================================================
//
// ðŸš¨ IMPORTANTE: Estas son las ÃšNICAS rutas que NO requieren autenticaciÃ³n
//
// Â¿POR QUÃ‰ ESTÃN SIN MIDDLEWARE?
// - Los usuarios necesitan poder acceder al login SIN estar logueados
// - El logout debe funcionar aÃºn si la sesiÃ³n estÃ¡ expirando  
// - Sin estas rutas pÃºblicas, nadie podrÃ­a iniciar sesiÃ³n inicialmente
//
// ðŸŽ¯ FUNCIONES PÃšBLICAS DISPONIBLES:
// âœ… Acceder al formulario de login (/login)
// âœ… Procesar el login (POST /login)  
// âœ… Cerrar sesiÃ³n y limpiar datos (/logout)
//
// ðŸ”’ NOTA CRÃTICA: TODO lo demÃ¡s requiere autenticaciÃ³n obligatoria

// ðŸ”‘ FORMULARIO DE LOGIN - PÃ¡gina pÃºblica accesible sin autenticaciÃ³n
// URL: /login â†’ Muestra el formulario de inicio de sesiÃ³n  
// FUNCIÃ“N: Permite a usuarios sin sesiÃ³n poder loguearse al sistema
// Cualquier persona puede acceder sin estar logueada

// MOSTRAR FORMULARIO DE LOGIN - RUTA PÃšBLICA
// Esta es la Ãºnica pÃ¡gina que ven los usuarios NO autenticados
// Cuando alguien intenta acceder a una ruta protegida â†’ Laravel los redirige aquÃ­
Route::get('/login', [AutenticacionController::class, 'mostrarLogin'])->name('login');

// PROCESAR LOGIN - RUTA PÃšBLICA (obvio, necesitas poder hacer login)
// AquÃ­ es donde Sanctum verifica las credenciales y CREA la SESIÃ“N
// Si las credenciales son correctas â†’ Laravel crea una sesiÃ³n
// Si son incorrectas â†’ regresa al formulario con errores
Route::post('/login', [AutenticacionController::class, 'login'])->name('login.post');

// PROCESAR LOGOUT - ESTA SÃ PODRÃA ESTAR PROTEGIDA (solo usuarios logueados pueden hacer logout)
// Destruye la SESIÃ“N y redirige al login
Route::post('/logout', [AutenticacionController::class, 'logout'])->name('logout')->middleware('auth');

// RUTA TEMPORAL PARA VER LA VISTA - SE PUEDE QUITAR DESPUÃ‰S
Route::get('/login-preview', function () {
    return view('vertical-menu-template-no-customizer.app-auth-login');
})->name('login.preview');
